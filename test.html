<!DOCTYPE html>
<html>
  <head>
  	<meta charset="UTF-8">
  	<link href="cos-ui.css" rel="stylesheet" type="text/css">
  	<link href="style.css" rel="stylesheet" type="text/css">
  	<!-- <link rel="stylesheet" href="font-awesome.css"> -->
    <script src="react.js"></script>
    <script src="browser.min.js"></script>
    <script src="jquery.min.js"></script>
  </head>
  <body>
    <div id="example"></div>
    <script type="text/babel">
	var Calendar = React.createClass({
		getInitialState: function () {
	        return {
	            curDate: '',
	            curYear: '',
	            curMonth: '',
	            curMonthCHN: '',
	            curMonthDay: '',
	            curWeekDay: '',
	            indexWeekDay: ''
	        };
	    },
	    componentDidMount: function(){
	    	var _date;
	    	if (this.props.date) {
	    		_date = new Date(this.props.date);
	    	} else {
	    		_date = new Date();
	    	}
	    	this.refreshDate(_date);
	    },
	    refreshDate: function(_date) {
	    	var $this = this;
	    	var _indexDate = new Date(JSON.parse(JSON.stringify(_date)));
	    	_indexDate = new Date(_indexDate.setDate(1));
	    	var _month = _date.getMonth() + 1;
	    	this.setState({
	    		curDate: _date,
	            curYear: _date.getFullYear(),
	            curMonth: _month,
	            curMonthCHN: $this.getMonthCHN(_month),
	            curMonthDay: _date.getDate(),
	            curWeekDay: _date.getDay(),
	            indexWeekDay: _indexDate.getDay()
	    	});
	    },
	    backToday: function(){
	    	var s = new Date();
	    	this.refreshDate(s);
	    },
	    getMonthCHN: function (month) {
	    	var result = '';
	    	switch (month) {
	    		case 1:
	    			result = '一月';
	    			break;
	    		case 2:
	    			result = '二月';
	    			break;
	    		case 3:
	    			result = '三月';
	    			break;
	    		case 4:
	    			result = '四月';
	    			break;
	    		case 5:
	    			result = '五月';
	    			break;
	    		case 6:
	    			result = '六月';
	    			break;
	    		case 7:
	    			result = '七月';
	    			break;
	    		case 8:
	    			result = '八月';
	    			break;
	    		case 9:
	    			result = '九月';
	    			break;
	    		case 10:
	    			result = '十月';
	    			break;
	    		case 11:
	    			result = '十一月';
	    			break;
	    		case 12:
	    			result = '十二月';
	    			break;
	    	}
	    	return result;
	    },
	    getTotalDays: function(month) {
	    	var sum = 0;
	    	switch (month) {
	    		case 1:
	    		case 3:
	    		case 5:
	    		case 7:
	    		case 8:
	    		case 10:
	    		case 12:
	    			sum += 31;
	    			break;
	    		case 4:
	    		case 6:
	    		case 9:
	    		case 11:
	    			sum += 30;
	    			break;
	    		case 2:
	    			this.isRun() ? sum += 29 : sum += 28
	    	}
	    	return sum;
	    },
	    isRun: function(){
	    	var year = this.state.curYear;
	    	if( (year % 4 == 0 && year % 100 != 0) || (year % 400 == 0)){
			 return true;
			} else { 
			 return false;
			}
	    },
	    preMonth: function() {
	    	var _month = this.state.curMonth;
	    	var _year = this.state.curYear;
	    	var _day = this.state.curMonthDay;
	    	if (_month == 1) {
	    		_month = 12;
	    		_year -= 1;
	    	} else {
	    		_month -= 1;
	    	}
	    	var dateNew =  new Date( _year + '-' + _month + '-' + _day);
	    	dateNew = new Date(dateNew);
	    	this.refreshDate(dateNew);
	    },
	    nextMonth: function() {
	    	var _month = this.state.curMonth;
	    	var _year = this.state.curYear;
	    	var _day = this.state.curMonthDay;
	    	if (_month == 12) {
	    		_month = 1;
	    		_year += 1;
	    	} else {
	    		_month += 1;
	    	}
	    	var dateNew =  new Date( _year + '-' + _month + '-' + _day);
	    	dateNew = new Date(dateNew);
	    	this.refreshDate(dateNew);
	    },
	    getTrList: function() {
	    	//总行数
	    	var trCount = 5;
	    	//月总日数
	    	var days = this.getTotalDays(this.state.curMonth);
	    	var daysPre = this.getTotalDays(this.state.curMonth-1 == 0 ? 12 : this.state.curMonth-1);
	    	//一号星期几
	    	var indexWeekDay = this.state.indexWeekDay;
	    	//用于拼接日子
	    	var tdArr = [];
	    	//首先把属于该月的全部添加
	    	for (var i = 0; i < days; i++) {
	    		tdArr.push({
	    			date: this.state.curYear+'-'+this.state.curMonth+'-'+(i+1),
    				display: i + 1,
    				className: (i+1) == this.state.curMonthDay ? 'showDate active' : 'showDate'
	    		});
	    	};
	    	//添加上一个月的
	    	if (indexWeekDay < 7 ) {
	    		var preDays = indexWeekDay;
	    		var preArr = [];
	    		for (var i=0; i < preDays; i++) {
	    			var _preYear = this.state.curMonth == 1 ? this.state.curYear - 1 : this.state.curYear;
	    			var _preMonth = this.state.curMonth == 1 ? 12 : this.state.curMonth - 1;
	    			var _preDay = daysPre--;
	    			preArr.push({
	    				date: _preYear+'-'+_preMonth+'-'+_preDay,
	    				display: _preDay,
	    				className: ''
	    			});
	    		};
	    		preArr.reverse();
	    		tdArr = preArr.concat(tdArr);
	    		days = days + preDays;
	    	};
	    	//确定最后的行数
	    	var _nextYear = this.state.curMonth == 12 ? this.state.curYear + 1 : this.state.year;
	    	var _nextMonth = this.state.curMonth == 12 ? 1 : this.state.curMonth +1;
	    	if (days > 35) {
	    		trCount = 6;
	    		var leftDays = 42 - days;
	    		for (var i = 0; i < leftDays; i++) {
	    			tdArr.push({
		    			date: _nextYear + '-' + _nextMonth + '-' +(i+1),
	    				display: i + 1,
	    				className: ''
		    		});
	    		};
	    	} else {
	    		var leftDays = 35 - days;
	    		for (var i = 0; i < leftDays; i++) {
	    			tdArr.push({
		    			date: _nextYear + '-' + _nextMonth + '-' +(i+1),
	    				display: i + 1,
	    				className: ''
		    		});
	    		};
	    	}
	    	var doms = [];
			for (var i = 0; i < trCount; i++) {
			  doms.push(
			  	<tr>
			  		<td data-date={tdArr[i*7].date} className={tdArr[i*7].className}>{tdArr[i*7].display}</td>
			  		<td data-date={tdArr[i*7+1].date} className={tdArr[i*7+1].className}>{tdArr[i*7+1].display}</td>
			  		<td data-date={tdArr[i*7+2].date} className={tdArr[i*7+2].className}>{tdArr[i*7+2].display}</td>
			  		<td data-date={tdArr[i*7+3].date} className={tdArr[i*7+3].className}>{tdArr[i*7+3].display}</td>
			  		<td data-date={tdArr[i*7+4].date} className={tdArr[i*7+4].className}>{tdArr[i*7+4].display}</td>
			  		<td data-date={tdArr[i*7+5].date} className={tdArr[i*7+5].className}>{tdArr[i*7+5].display}</td>
			  		<td data-date={tdArr[i*7+6].date} className={tdArr[i*7+6].className}>{tdArr[i*7+6].display}</td>
			  	</tr>
			  );
			}
			return doms;
	    },
	    handleDatePick: function(e) {
	    	var td = e.target;
	    	var pickDate = td.getAttribute('data-date');
	    	React.findDOMNode(this.refs.dest).value = pickDate;
	    	this.refreshDate(new Date(pickDate));
	    },
	    toggleMonthBox: function () {
	    	var monthBox = React.findDOMNode(this.refs.monthBox);
	    	if (monthBox.style.display == "block") {
	    		monthBox.style.display = "none";
	    	} else {
	    		monthBox.style.display = "block";
	    		var monthList = monthBox.children;
	    		for (var i = 0; i < 12; i++) {
	    			monthList[i].className = "";
	    			if (i+1 == this.state.curMonth) {
	    				monthList[i].className = "active";
	    			};
	    		};
	    	}
	    },
	    toggleYearBox: function () {
	    	var yearBox = React.findDOMNode(this.refs.yearBox);
	    	if (yearBox.style.display == "block") {
	    		yearBox.style.display = "none";
	    	} else {
	    		yearBox.style.display = "block";
	    	}
	    },
	    fillYear: function () {
	    	var yearList = [];
	    	for (var i = 1900; i < 2100; i++) {
	    		
	    	};
	    },
	    monthPick: function(e) {
	    	e = e || window.event;
	    	if (e.target.nodeName.toLowerCase() == "span") {
	    		var selectMonth = e.target.getAttribute('data-month');
	    		this.refreshDate(new Date(this.state.curYear+'-'+selectMonth+'-'+this.state.curMonthDay));
	    	};
	    },
		render: function() {
			var doms = this.getTrList();
			return (
			  <div className="calenderHolder">
			  	<input className={this.props.inputClassName} ref="dest"/>
			  	<div className="cal-main">
			  		<div className="cal-header">
				  		<span className="preMonth"><i className="fa fa-caret-left" onClick={this.preMonth}></i></span>
			  		 	<span className="home"><i title="今天" className="fa fa-home" onClick={this.backToday}></i></span>
				  		<span className="monthHold" onClick={this.toggleMonthBox}>
				  		 <span>{this.state.curMonthCHN}</span>
				  		 <i className="fa fa-sort-desc"></i>
				  		 <div className="monthBox" ref="monthBox" onClick={this.monthPick}>
				  		 	<span data-month="1">一月</span>
				  		 	<span data-month="2">二月</span>
				  		 	<span data-month="3">三月</span>
				  		 	<span data-month="4">四月</span>
				  		 	<span data-month="5">五月</span>
				  		 	<span data-month="6">六月</span>
				  		 	<span data-month="7">七月</span>
				  		 	<span data-month="8">八月</span>
				  		 	<span data-month="9">九月</span>
				  		 	<span data-month="10">十月</span>
				  		 	<span data-month="11">十一月</span>
				  		 	<span data-month="12">十二月</span>
				  		 </div>
				  		</span>
				  		<span className="yearHold" onClick={this.toggleYearBox}>
				  			<span>{this.state.curYear}</span>
				  			<i className="fa fa-sort-desc"></i>
				  			
				  		</span>
				  		<span className="nextMonth"><i className="fa fa-caret-right" onClick={this.nextMonth}></i></span>
			  		</div>
			  		<table className="cal-dateTable">
			  		 <thead>
				  		 <tr>
				  		 	<th>日</th>
				  		 	<th>一</th>
				  		 	<th>二</th>
				  		 	<th>三</th>
				  		 	<th>四</th>
				  		 	<th>五</th>
				  		 	<th>六</th>
				  		 </tr>
			  		 </thead>
			  		 <tbody onClick={this.handleDatePick}>
			  		 	{doms}
			  		 </tbody>
			  		</table>
			  	</div>
			  </div>
			);
		}
	});

	React.render(
		<Calendar
		 inputClassName = "ipt-area ipt-area2 ipt-area3"
		 date="" />,
		document.getElementById('example')
	);
    </script>
  </body>
</html>
<!-- <div className="yearBox" ref="yearBox" onClick={this.yearPick}></div> -->
